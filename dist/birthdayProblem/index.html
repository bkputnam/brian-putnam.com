<!DOCTYPE html>
<html lang="en-US">
	<head>
		<title>Birthday Problem Calculator</title>
		<style>
			html {
				margin: 0;
				padding: 0;
			}
			body {
				margin: 8px;
				padding: 0;
			}
			th {
				text-align: left;
				padding-right: 5px;
			}
			#errors {
				color: red;
				margin: 8px;
			}
			.calculated {
				box-shadow: 0 0 3px 1px green;
			}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script>
			$(function() {

				var $birthdayForm = $("#birthday-form");
				var $setSize = $("#set-size");
				var $numDraws = $("#num-draws");
				var $pctProb = $("#pct-prob");
				var $errors = $("#errors");

				$birthdayForm.on("submit", function(e) {
					e.preventDefault();

					$setSize.add( $numDraws ).add( $pctProb ).removeClass("calculated");
					$errors.empty();

					var setSize = $setSize.val();
					var numDraws = $numDraws.val();
					var pctProb = $pctProb.val();

					setSize = setSize ? parseInt(setSize) : Number.NaN;
					numDraws = numDraws ? parseInt(numDraws) : Number.NaN;
					pctProb = pctProb ? parseFloat(pctProb) : Number.NaN;

					try {
						if( !setSize ) {
							solveForSetSize( numDraws, pctProb );
						}
						else if( !numDraws ) {
							solveForNumDraws( setSize, pctProb );
						}
						else if( !pctProb ) {
							solveForPctProb( setSize, numDraws );
						}
						else {
							// TODO: What do we do if they've filled in everything?
							throw new Error("Leave something blank and it will be calculated.");
						}
					}
					catch (e) {
						$errors.text( e.message || e );
						console.error( e.stack || e );
					}
				});

				function solveForSetSize( numDraws, pctProb ) {

					var targetProb = pctProb / 100;
					
					var prev = numDraws;
					var cur = numDraws + 1;

					var _calcProb = function( setSize ) {
						return calcProb( setSize, numDraws );
					};

					while( _calcProb(cur) > targetProb ) {
						prev = cur;
						cur *= 2;
					}

					var setSize = binarySearchIndices( prev, cur, _calcProb, targetProb );
					var curProb = _calcProb(setSize);
					while( curProb > targetProb ) {
						setSize++;
						curProb = _calcProb(setSize);
					}

					$setSize.val( setSize );
					$pctProb.val( curProb * 100 );
				}

				function solveForNumDraws( setSize, pctProb ) {
					var targetProb = pctProb / 100;

					var curProb = -1;
					var probNoCollision = 1;
					var numDraws = 0;
					while( curProb < targetProb ) {
						probNoCollision *= (setSize - numDraws) / setSize;
						numDraws++;
						curProb = 1 - probNoCollision;
					}

					$numDraws.val( numDraws ).addClass( "calculated" );
					$pctProb.val( curProb * 100 );
				}

				function solveForPctProb( setSize, numDraws ) {
					var pctProb = calcProb( setSize, numDraws ) * 100;
					$pctProb.val( pctProb ).addClass( "calculated" );
				}

				function calcProb( setSize, numDraws ) {
					var probNoCollision = 1;

					// technically we should start at i=0, but that will always be a noop because
					// (setSize - 0)/setSize === 1
					for( var i=1; i<numDraws; i++ ) {
						probNoCollision *= (setSize - i) / setSize;
					}

					return 1 - probNoCollision;
				}

				function binarySearchIndices(minIndex, maxIndex, map, target) {
					var curVal;
					while( maxIndex > minIndex ) {
						var middleIndex = Math.floor( (minIndex + maxIndex) / 2 );
						curVal = map( middleIndex );

						if( middleIndex == minIndex || curVal == target ) {
							return middleIndex;
						}

						// Note comparison is backwards here because mapped values (probabilities)
						// vary inversely with index (prob goes down as index goes up)
						if( target > curVal ) {
							maxIndex = middleIndex;
						}
						else {
							minIndex = middleIndex;
						}
					}
				}
			});
		</script>
	</head>
	<body>
		<h1>Birthday Problem Calculator</h1>
		<p>
			For more info about the the Birthday Problem, see
			<a href="https://en.wikipedia.org/wiki/Birthday_problem">Wikipedia</a>
		</p>
		<p>
			Leave any field blank to calculate that value! Note that Percent Probability will
			usually update itself after a calculation (even if you filled it in). This is because
			exact probabilities are hard to find given that Set Size and Num Draws must be exact
			integers. For example, if you select Set Size = 365 and Percent Probability = 50% and
			then ask for Num Draws to be calculated it will calculate Num Draws = 23 and then
			recalculate Percent Probability &asymp; 50.7% because there is no value
			of Num Draws that will give you exactly a 50% Percent Probability.
		</p>
		<form id="birthday-form">
			<table>
				<tr>
					<th><label>Set Size:</label></th>
					<td><input type="number" id="set-size" min="1" value="365" /></td>
				</tr>
				<tr>
					<th><label>Num Draws:</label></th>
					<td><input type="number" id="num-draws" min="0" value="23" /></td>
				</tr>
				<tr>
					<th><label>Percent Probability:</label></th>
					<td>
						<input type="number" id="pct-prob"
							min="0" max="100" step="any"
							value="50.729723432398565"
						/>%
						chance of at least 1 collision.
					</td>
				</tr>
			</table>
			<button type="submit">Calculate missing value!</button>
			<div id="errors"></div>
		</form>
	</body>
</html>
